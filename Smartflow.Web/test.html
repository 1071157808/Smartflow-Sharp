<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <script src="jquery-1.6.4.min.js"></script>
    <script src="svg.js"></script>

    <style type="text/css">
        html, body, div, ul {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ul {
            list-style-type: none;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        .container {
            height: 100%;
            overflow: hidden;
        }

        .tools {
            width: 120px;
            float: left;
            background-color: #eee;
            height: 100%;
        }

            .tools::after {
                content: ".";
                display: block;
                visibility: hidden;
                height: 1%;
                clear: both;
            }

        #drawing {
            width: 100%;
            height: 100%;
        }

        .tools-menu li {
            line-height: 25px;
            text-align: center;
        }

        div {
            -moz-user-select: none;
            -webkit-user-select: none;
            user-select: none;
        }

        text {
            font-size: 16px;
            text-anchor: middle; /* 文本水平居中 */
            pointer-events:none;
        }
        rect:hover{
            background-color:#00ff90;
        }
    </style>
    <script type="text/javascript">
        var draw, nodeArray = {}, LineArray = {},
        line = {
            x1: 0,
            y1: 0,
            x2: 0,
            y2: 0,
            ox: 0,
            oy: 0
        };

        window.onload = function () {
            if (SVG.supported) {
                draw = SVG('drawing');


                draw.mouseup(function (e) {
                    draw.off('mousemove');
                });
            } else {
                alert('SVG not supported')
            }
        }

        //选择
        function select() {
            $(document).unbind('mousedown');
            $(document).unbind('mouseup');
            draw.each(function (i, child) {
                if (this.type === 'rect') {
                    this.mousedown(function (e) {
                        var n = nodeArray[this.id()];
                        rectDrag.apply(this, [n]);
                    });
                }
            });
        }


        //连接节点
        function connect() {
            $(document).unbind('mousedown');
            $(document).unbind('mouseup');

            draw.each(function (i, child) {
                if (this.type === 'rect') {
                    this.off('mousedown');
                }
            });

            $(document).bind('mousedown', function (e) {
                var nodeName = $(e.target).get(0).nodeName,
                    nid = $(e.target).get(0).id;
                if (nodeName === 'rect') {
                    var rect = SVG.get(nid);
                    line.x1 = rect.width() / 2 + rect.x();
                    line.y1 = rect.height() + rect.y();
                    line['from'] = rect.id();
                }
                e.preventDefault();//阻止默认事件，取消文字选中
                return false;
            });
            $(document).bind('mouseup', function (e) {
                var nodeName = $(e.target).get(0).nodeName,
                       nid = $(e.target).get(0).id;

                if (nodeName === 'rect') {
                    var rect = SVG.get(nid);
                    line.x2 = rect.width() / 2 + rect.x();
                    line.y2 = rect.y();
                    line['to'] = rect.id();
                    if (line.from !== line.to&&line.from) {
                        var instance = new Line();
                        $.extend(instance, line);
                        var nt = nodeArray[nid],
                            id = instance.draw(),
                            nf = nodeArray[line.from];

                        var l = SVG.get(id),
                            r = SVG.get(instance.from);


                        nt.to.push({ id: id, rectId: nid });
                        nf.from.push({ id: id, rectId: line.from });
                        LineArray[id] = instance;
                        nt.ox2 = l.attr("x2") - rect.x();
                        nt.oy2 = l.attr("y2") - rect.y();
                        nf.ox1 = l.attr("x1") - r.x();
                        nf.oy1 = l.attr("y1")- r.y();
                    }
                }
                return false;
            });
        }

        //创建节点
        function createNode() {
            var n = new Node(),
                id = n.draw();
            nodeArray[id] = n;
        }

        //线条
        function Line() {
            this.x1 = 0;
            this.y1 = 0;
            this.x2 = 0;
            this.y2 = 0;
       
        }

        Line.prototype = {
            constructor: Line,
            draw: function () {
                var l = draw.line(this.x1,
                                  this.y1,
                                  this.x2,
                                  this.y2)
                    .stroke({ width: 1 });
                return l.id();
            }
        }

        //节点
        function Node() {
            this.w = 180;
            this.h = 50;
            this.x = 10;
            this.y = 10;
            this.cx = 80;
            this.cy = 0;
            this.disX = 0;
            this.disY = 0;
            this.from = [];
            this.to = [];
            this.text = '';
            this.ox1 = 0;
            this.oy1 = 0;
            this.ox2 = 0;
            this.oy2 = 0;
            this.name = 'node';
            this.enable = false;
        }

        Node.prototype = {
            constructor: Node,
            draw: function () {
                var n = this;
                var rect = draw.rect(n.w, n.h)
                     .attr({ fill: '#f06', x: n.x, y: n.y });

                nodeArray[rect.id()] = n;
                n.text = draw.text(function (add) {
                    add.tspan(n.name);
                });
                n.text.attr({ x: n.x + rect.width() / 2, y: n.y + rect.height() / 2 });

                rect.mousedown(function (e) {
                    var nx = nodeArray[this.id()];
                    nx.disX = e.clientX - this.x() - nx.cx;
                    nx.disY = e.clientY - this.y() - nx.cy;
                    rectDrag.apply(this, [nx]);
                });
                rect.dblclick(function () {
                    var nx = nodeArray[this.id()],
                        nodeName = prompt("请输入节点名称", nx.name);
                    if (nodeName) {
                        nx.name = nodeName;
                        nx.text.clear();
                        nx.text.text(function (add) {
                            add.tspan(nx.name);
                        });
                    }
                });
                rect.mouseout(function () {
                    this.attr({ fill: '#f06' });
                    this.data('select', { select: false });
                });
                rect.mouseover(function (e) {
                    this.attr({ fill: '#f8e233' });
                    this.data('select',{ select: true });
                });
                return rect.id();
            }
        };

        window.document.onkeydown = removeElement;
        function removeElement(evt) {
            evt = (evt) ? evt : window.event
            if (evt.keyCode===46) {

                for (var p in nodeArray) {
                    var node = nodeArray[p],
                        rect = SVG.get(p);

                    if (!rect.data('select')) return;
                    var data = rect.data('select');
                    if (!data) continue;
                    if (data && data.select) {
                        rect.remove();
                        node.text.remove();
                        delElement(node.from);
                        delElement(node.to);
                        delete nodeArray[p];
                    }
                }
            }
        }

        function delElement(elements) {
            if (elements && elements.length > 0) {
                $.each(elements, function () {
                    SVG.get(this.id).remove();

                    nodeArray[this.rectId].from = [];
                    nodeArray[this.rectId].to = [];

                });
            }
        }

        //节点移动
        function rectDrag(n) {
            var self = this;
            var nx = nodeArray[self.id()];
            draw.on('mousemove', function (d) {
                nx.x =d.clientX - n.disX - n.cx;
                nx.y = d.clientY - n.disY - n.cy;
                self.attr({x:nx.x,y: n.y});

                if (nx.text) {
                    nx.text.attr({ x: (self.x() + (self.width() / 2)), y: self.y() + (self.height() / 2) });
                }

                if (nx.to.length > 0) {
                    $.each(nx.to, function (i, o) {
                        var ele = SVG.get(o.id);
                        ele.attr({ x2: nx.x+nx.ox2, y2: nx.y+nx.oy2 });
                    });
                }

                if (nx.from.length > 0) {
                    $.each(nx.from, function (i, o) {
                        var ele = SVG.get(o.id);
                        ele.attr({ x1: nx.x + nx.ox1, y1: nx.y + nx.oy1 });
                    });
                }
            });
        }

        function save() {
            alert(JSON.stringify(nodeArray));
        }
    </script>
</head>
<body>
    <div class="tools">
        <ul class="tools-menu">
            <li>
                <a href="#" onclick="save()">保存</a>
            </li>
            <li>
                <a href="#" onclick="select()">选择</a>
            </li>
            <li>
                <a href="#" onclick="connect()">连接</a>
            </li>
            <li>
                <a href="#" onclick="createNode()">节点</a>
            </li>
        </ul>
    </div>
    <div class="container">
        <div id="drawing"></div>
    </div>
</body>
</html>
